#!/usr/bin/env bash
# wp-search - Search and replace filter for wp kanban
# Reads from stdin, applies substitution, writes to stdout, commits the change

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WP_ROOT="$(dirname "$SCRIPT_DIR")"

# Source the common library
source "$WP_ROOT/lib/wp-common.sh"

# TODO task-08: migrate _escape_sed to lib/wp-common.sh as wp_escape_sed
# Note: wp_escape_sed already exists in wp-common.sh, using it directly

# Print usage information
usage() {
    cat >&2 <<EOF
Usage: wp-search [OPTIONS] PATTERN REPLACEMENT

Search and replace filter. Reads from stdin, writes to stdout, commits the change.

Options:
  -i          Case-insensitive matching
  -g          Replace all occurrences per line (default behavior)
  -n N        Replace only the Nth occurrence per line
  -r          PATTERN is an extended regular expression (ERE)
  -p          Preview mode: show a colored diff, do not commit
  -h, --help  Show this help message

Arguments:
  PATTERN     The text or regex to search for
  REPLACEMENT The text to substitute in

Examples:
  echo "hello world" | wp-search "world" "there"
  echo "Cat cat CAT" | wp-search -i "cat" "dog"
  echo "Mr. Smith and Mrs. Jones" | wp-search -r '(Mr|Mrs)\.' 'Mx.'
  echo "a b a b a" | wp-search -n 2 "a" "X"
EOF
    exit 1
}

# Parse options
CASE_INSENSITIVE=""
NTH_OCCURRENCE=""
USE_ERE=""
PREVIEW_MODE=false

while getopts ":ign:rph-:" opt; do
    case "$opt" in
        i)
            CASE_INSENSITIVE="I"
            ;;
        g)
            # Default behavior, nothing to set
            ;;
        n)
            NTH_OCCURRENCE="$OPTARG"
            ;;
        r)
            USE_ERE="-E"
            ;;
        p)
            PREVIEW_MODE=true
            ;;
        -)
            # Handle long options
            case "${OPTARG}" in
                help)
                    usage
                    ;;
                *)
                    wp_log ERR "Unknown option: --${OPTARG}"
                    usage
                    ;;
            esac
            ;;
        h)
            usage
            ;;
        \?)
            wp_log ERR "Invalid option: -$OPTARG"
            usage
            ;;
    esac
done
shift $((OPTIND - 1))

# Check for required arguments
if [[ $# -lt 2 ]]; then
    wp_log ERR "PATTERN and REPLACEMENT are required"
    usage
fi

PATTERN="$1"
REPLACEMENT="$2"

# Escape pattern and replacement for sed
# For ERE mode (-r), we need different escaping
if [[ -n "$USE_ERE" ]]; then
    # In ERE mode, only escape the delimiter | (backslash is part of regex syntax)
    # | must be escaped as \| in the pattern for ERE when using | as delimiter
    ESCAPED_PATTERN=$(printf '%s' "$PATTERN" | sed 's/|/\\|/g')
    ESCAPED_REPLACEMENT=$(printf '%s' "$REPLACEMENT" | sed 's/[&|]/\\&/g')
else
    # In basic mode, escape all special characters including | for the delimiter
    ESCAPED_PATTERN=$(printf '%s' "$PATTERN" | sed -e 's/[]\/$*.^[]/\\&/g' -e 's/|/\\|/g')
    ESCAPED_REPLACEMENT=$(printf '%s' "$REPLACEMENT" | sed -e 's/[]\/$*.^[]/\\&/g' -e 's/|/\\|/g')
fi

# Build sed flags
SED_FLAGS=""
if [[ -n "$NTH_OCCURRENCE" ]]; then
    # Replace only Nth occurrence
    SED_FLAGS="$NTH_OCCURRENCE"
else
    # Replace all occurrences (default)
    SED_FLAGS="g"
fi

# Add case-insensitive flag if specified
if [[ -n "$CASE_INSENSITIVE" ]]; then
    SED_FLAGS="${SED_FLAGS}${CASE_INSENSITIVE}"
fi

# Build sed command
SED_CMD="s|${ESCAPED_PATTERN}|${ESCAPED_REPLACEMENT}|${SED_FLAGS}"

# Read stdin
INPUT=$(cat)

# Check if input is empty
if [[ -z "$INPUT" ]]; then
    if [[ "$PREVIEW_MODE" == true ]]; then
        # Preview mode with empty input - nothing to show
        exit 0
    else
        # Empty input, commit empty result
        echo -n "" | wp_commit
        exit 0
    fi
fi

if [[ "$PREVIEW_MODE" == true ]]; then
    # Preview mode: show diff without committing
    TMPFILE=$(mktemp)
    trap "rm -f $TMPFILE" EXIT

    # Apply substitution to temp file
    echo "$INPUT" | sed $USE_ERE "$SED_CMD" > "$TMPFILE"

    # Show colored diff
    diff --color=always <(echo "$INPUT") "$TMPFILE" || true
else
    # Normal mode: apply substitution, output to stdout, and commit
    OUTPUT=$(echo "$INPUT" | sed $USE_ERE "$SED_CMD")
    echo "$OUTPUT"
    echo "$OUTPUT" | wp_commit
fi
