#!/usr/bin/env bash
# wp-undo - History navigation tool for wp kanban
# Manipulates session/current symlink and session/meta sequence counter

set -euo pipefail

source "$(dirname "${BASH_SOURCE[0]}")/../lib/wp-common.sh"

# Print usage information
usage() {
    cat <<EOF
Usage: wp-undo [OPTIONS]

Options:
  (none)      Step back one snapshot
  -n N        Step back N snapshots
  --list      Print full history with sequence number, timestamp, and word count
  --diff N    Show a colored diff between current snapshot and N steps back
  --jump N    Restore snapshot number N absolutely (ignores current position)
  --prune N   Delete all snapshots older than the most recent N; cannot be undone
EOF
}

# Get the path to a snapshot file by sequence number
# Args: $1 = sequence number (integer)
# Returns: absolute path to snapshot file
get_snapshot_path() {
    local seq="$1"
    local session_dir
    session_dir="$(wp_session_dir)"
    local padded_seq
    padded_seq=$(printf "%04d" "$seq")
    echo "$session_dir/history/${padded_seq}.txt"
}

# Update the current symlink and meta file to point to a new sequence
# Args: $1 = target sequence number
update_current() {
    local target="$1"
    local session_dir
    session_dir="$(wp_session_dir)"
    local current_link="$session_dir/current"
    local meta_file="$session_dir/meta"
    local snapshot_path
    snapshot_path="$(get_snapshot_path "$target")"
    local padded_target
    padded_target=$(printf "%04d" "$target")

    # Update symlink
    ln -sfn "$snapshot_path" "$current_link"

    # Update meta file (preserve source= line)
    local source_file="unknown"
    if [[ -f "$meta_file" ]]; then
        source_file=$(grep '^source=' "$meta_file" | cut -d'=' -f2-)
    fi
    {
        echo "seq=$padded_target"
        echo "source=$source_file"
    } > "$meta_file"
}

# Get the maximum sequence number from history directory
get_max_seq() {
    local session_dir
    session_dir="$(wp_session_dir)"
    local history_dir="$session_dir/history"
    local max=0

    if [[ -d "$history_dir" ]]; then
        for f in "$history_dir"/*.txt; do
            if [[ -f "$f" ]]; then
                local basename
                basename=$(basename "$f" .txt)
                local num=$((10#$basename))
                if ((num > max)); then
                    max=$num
                fi
            fi
        done
    fi
    echo "$max"
}

# Count words in a file
count_words() {
    local file="$1"
    wc -w < "$file" | tr -d ' '
}

# Step back N snapshots
step_back() {
    local n="${1:-1}"
    local current_seq
    current_seq="$(wp_seq)"
    local target=$((current_seq - n))

    if ((target < 1)); then
        wp_log ERR "Already at oldest snapshot"
        exit 1
    fi

    update_current "$target"
}

# List all snapshots with sequence, timestamp, and word count
list_history() {
    local session_dir
    session_dir="$(wp_session_dir)"
    local history_dir="$session_dir/history"
    local current_seq
    current_seq="$(wp_seq)"

    if [[ ! -d "$history_dir" ]]; then
        return 0
    fi

    # Get sorted list of snapshot files
    local files=()
    while IFS= read -r -d '' f; do
        files+=("$f")
    done < <(find "$history_dir" -maxdepth 1 -name '*.txt' -print0 | sort -z)

    for f in "${files[@]}"; do
        local basename
        basename=$(basename "$f" .txt)
        local seq=$((10#$basename))
        local padded
        padded=$(printf "%04d" "$seq")
        local timestamp
        timestamp=$(stat --format='%y' "$f" | cut -d'.' -f1)
        local words
        words=$(count_words "$f")
        local current_marker=""
        if ((seq == current_seq)); then
            current_marker="   â† current"
        fi
        printf "  [%s]  %s  %d words%s\n" "$padded" "$timestamp" "$words" "$current_marker"
    done
}

# Show diff between current and N steps back
show_diff() {
    local n="${1:-1}"
    local current_seq
    current_seq="$(wp_seq)"
    local target=$((current_seq - n))

    if ((target < 1)); then
        wp_log ERR "Nothing to diff"
        exit 0
    fi

    local target_path
    target_path="$(get_snapshot_path "$target")"
    local current_path
    current_path="$(wp_current)"

    # Check if delta is available
    if command -v delta &>/dev/null; then
        diff --color=always <(cat "$target_path") <(cat "$current_path") | delta
    else
        diff --color=always <(cat "$target_path") <(cat "$current_path")
    fi
}

# Jump to absolute snapshot number
jump_to() {
    local target="$1"
    local session_dir
    session_dir="$(wp_session_dir)"
    local history_dir="$session_dir/history"
    local padded_target
    padded_target=$(printf "%04d" "$target")
    local snapshot_path="$history_dir/${padded_target}.txt"

    if [[ ! -f "$snapshot_path" ]]; then
        wp_log ERR "Snapshot $padded_target does not exist"
        exit 1
    fi

    update_current "$target"
    echo "Restored snapshot $padded_target" >&2
}

# Prune old snapshots
prune_old() {
    local keep="$1"
    local max_seq
    max_seq="$(get_max_seq)"

    if ((keep >= max_seq)); then
        wp_log INFO "Nothing to prune"
        exit 0
    fi

    local cutoff=$((max_seq - keep))
    local to_delete=()

    for ((seq = 1; seq <= cutoff; seq++)); do
        local snapshot_path
        snapshot_path="$(get_snapshot_path "$seq")"
        if [[ -f "$snapshot_path" ]]; then
            to_delete+=("$snapshot_path")
        fi
    done

    local count=${#to_delete[@]}
    if ((count == 0)); then
        wp_log INFO "Nothing to prune"
        exit 0
    fi

    # Prompt user
    echo -n "About to delete $count snapshots. Continue? [y/N] " >&2
    local response
    response=$(read -r < /dev/tty)

    if [[ "$response" =~ ^[Yy]$ ]]; then
        for f in "${to_delete[@]}"; do
            rm "$f"
        done
        wp_log INFO "Deleted $count snapshots"
    else
        wp_log INFO "Prune cancelled"
    fi
}

# Main argument parsing
main() {
    if [[ $# -eq 0 ]]; then
        step_back 1
        return
    fi

    case "$1" in
        -n)
            if [[ -z "${2:-}" ]]; then
                wp_log ERR "-n requires a number argument"
                exit 1
            fi
            step_back "$2"
            ;;
        --list)
            list_history
            ;;
        --diff)
            if [[ -z "${2:-}" ]]; then
                wp_log ERR "--diff requires a number argument"
                exit 1
            fi
            show_diff "$2"
            ;;
        --jump)
            if [[ -z "${2:-}" ]]; then
                wp_log ERR "--jump requires a number argument"
                exit 1
            fi
            jump_to "$2"
            ;;
        --prune)
            if [[ -z "${2:-}" ]]; then
                wp_log ERR "--prune requires a number argument"
                exit 1
            fi
            prune_old "$2"
            ;;
        -h|--help)
            usage
            ;;
        *)
            wp_log ERR "Unknown option: $1"
            usage
            exit 1
            ;;
    esac
}

main "$@"
